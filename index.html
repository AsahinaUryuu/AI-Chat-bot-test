<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸ƒä¸ƒ AI å¯¹è¯</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f4f4f9; }
        #chat-box { height: 400px; border: 1px solid #ddd; background: white; overflow-y: scroll; padding: 15px; margin-bottom: 15px; border-radius: 10px; }
        .msg { margin: 8px 0; padding: 10px; border-radius: 8px; max-width: 80%; }
        .sent { background-color: #95ec69; float: right; clear: both; }
        .received { background-color: #fff; float: left; clear: both; border: 1px solid #eee; }
        .input-area { display: flex; gap: 10px; clear: both; padding-top: 10px; }
        input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 10px 20px; background: #5b6caf; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #status { font-size: 12px; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h2>â„ï¸ åƒµå°¸å¨˜ ä¸ƒä¸ƒ</h2>
    <div id="status">ğŸ”´ æœªè¿æ¥</div>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="msgInput" placeholder="å’Œä¸ƒä¸ƒè¯´è¯..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">å‘é€</button>
    </div>

    <script>
        const ws = new WebSocket("ws://127.0.0.1:8000/ws/chat");
        ws.binaryType = "arraybuffer"; // ã€å…³é”®ã€‘æ¥æ”¶äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®

        const chatBox = document.getElementById('chat-box');
        const statusDiv = document.getElementById('status');
        
        // éŸ³é¢‘æ’­æ”¾ç›¸å…³
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;

        ws.onopen = () => { statusDiv.innerText = "ğŸŸ¢ å·²è¿æ¥"; statusDiv.style.color = "green"; };
        ws.onclose = () => { statusDiv.innerText = "ğŸ”´ æ–­å¼€è¿æ¥"; statusDiv.style.color = "red"; };

        ws.onmessage = async (event) => {
            const data = event.data;

            // 1. å¦‚æœæ˜¯éŸ³é¢‘æ•°æ® (ArrayBuffer)
            if (data instanceof ArrayBuffer) {
                console.log("æ”¶åˆ°éŸ³é¢‘æ•°æ®:", data.byteLength);
                if (!audioContext) initAudio(); // ç¡®ä¿éŸ³é¢‘å¼•æ“å¯åŠ¨
                try {
                    const audioBuffer = await audioContext.decodeAudioData(data);
                    playAudioChunk(audioBuffer);
                } catch (e) {
                    console.error("éŸ³é¢‘è§£ç å¤±è´¥:", e);
                }
            } 
            // 2. å¦‚æœæ˜¯æ–‡æœ¬å­—å¹• (JSON)
            else {
                try {
                    const msg = JSON.parse(data);
                    if (msg.type === "text") appendMessage("AI", msg.content);
                } catch (e) { console.log("éJSONæ¶ˆæ¯:", data); }
            }
        };

        function appendMessage(sender, text) {
            let lastMsg = chatBox.lastElementChild;
            if (sender === "AI" && lastMsg && lastMsg.dataset.sender === "AI") {
                lastMsg.innerText += text;
            } else {
                const div = document.createElement("div");
                div.className = `msg ${sender === "æˆ‘" ? "sent" : "received"}`;
                div.dataset.sender = sender;
                div.innerText = text;
                chatBox.appendChild(div);
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            initAudio(); // ç”¨æˆ·ç‚¹å‡»æ—¶æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
            const input = document.getElementById("msgInput");
            if (input.value) {
                ws.send(input.value);
                appendMessage("æˆ‘", input.value);
                input.value = "";
            }
        }

        // éŸ³é¢‘é˜Ÿåˆ—æ’­æ”¾ç³»ç»Ÿ
        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function playAudioChunk(buffer) {
            audioQueue.push(buffer);
            if (!isPlaying) playNext();
        }

        function playNext() {
            if (audioQueue.length === 0) { isPlaying = false; return; }
            isPlaying = true;
            const source = audioContext.createBufferSource();
            source.buffer = audioQueue.shift();
            source.connect(audioContext.destination);
            source.start(0);
            source.onended = playNext;
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }
    </script>
</body>
</html>